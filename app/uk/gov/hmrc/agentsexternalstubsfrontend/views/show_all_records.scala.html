@import play.api.Configuration
@import uk.gov.hmrc.agentsexternalstubsfrontend.models._
@import uk.gov.hmrc.agentsexternalstubsfrontend.ViewHelper
@import uk.gov.hmrc.play.views.html.helpers.{form, input, dropdown, inputRadioGroup}

@import uk.gov.hmrc.play.binders.ContinueUrl
@import com.fasterxml.jackson.core.util.DefaultPrettyPrinter
@import play.api.libs.json.{Json,JsObject,JsValue,JsString,JsArray}
@(records: Records, planetId: String, showId: Option[String])(implicit request: Request[_], messages: Messages, config: Configuration)

@uk.gov.hmrc.agentsexternalstubsfrontend.views.html.main_template(title = Messages("records.title"), bodyClasses = Some("full-width"), sidebarLinks = None) {

    <nav style="margin-bottom: 1em; text-align: right;">
        <a href="/agents-external-stubs/user">@Messages("users.link.current")</a> | <a href="/agents-external-stubs/users">@Messages("users.link.all")</a> | <a href="/gg/sign-out">@Messages("common.sign-out")</a>
    </nav>

    <h1 class="heading-xlarge">@Messages("records.show.header", planetId)</h1>

    <p>
        @Messages("records.show.description")
    </p>

    <table id="users" style="margin:1em 0;">
        <caption id="tableSubHeader" class="normal-text">Business Partner Records</caption>
        <col style="width: 90%">
        <col style="width: 10%">
        <tbody>
        @recordRows(records.BusinessPartnerRecord, ViewHelper.excerpt(_, "agentReferenceNumber", "utr", "nino", "eori", "addressDetails"))
        </tbody>
    </table>

    <table id="users" style="margin:1em 0;">
        <caption id="tableSubHeader" class="normal-text">Business Details Records</caption>
        <col style="width: 90%">
        <col style="width: 10%">
        <tbody>
        @recordRows(records.BusinessDetailsRecord, ViewHelper.excerpt(_,"nino","mtdbsa","businessData.0.tradingName", "businessData.0.businessAddressDetails", "businessData.0.cessationDate"))
        </tbody>
    </table>

    <table id="users" style="margin:1em 0;">
        <caption id="tableSubHeader" class="normal-text">VAT Customer Information Records</caption>
        <col style="width: 90%">
        <col style="width: 10%">
        <tbody>
        @recordRows(records.VatCustomerInformationRecord, ViewHelper.excerpt(_,"vrn","approvedInformation.customerDetails.organisationName","approvedInformation.customerDetails.individual", "approvedInformation.customerDetails.effectiveRegistrationDate"))
        </tbody>
    </table>

    <table id="users" style="margin:1em 0;">
        <caption id="tableSubHeader" class="normal-text">Legacy Relationship Records</caption>
        <col style="width: 90%">
        <col style="width: 10%">
        <tbody>
        @recordRows(records.LegacyRelationshipRecord, identity)
        </tbody>
    </table>

    <table id="users" style="margin:1em 0;">
        <caption id="tableSubHeader" class="normal-text">Legacy Agents Records</caption>
        <col style="width: 90%">
        <col style="width: 10%">
        <tbody>
        @recordRows(records.LegacyAgentRecord, identity)
        </tbody>
    </table>

}

@recordRows(records: Option[Seq[JsObject]], excerpt: JsValue => JsValue) = {
  @if(records.isEmpty){ <tr>
                          <td>
                              <div style="font-size:0.8em;">No records found.</div>
                          </td>
                      </tr>
  } else {
    @records.get.map{json => @recordRow(json, (json \ "id").asOpt[String], excerpt)}
  }
}

@recordRow(json: JsValue, id: Option[String], excerpt: JsValue => JsValue) = {
    <tr>
        @if(showId.isDefined && id.contains(showId.get)) {
            <a name="e"></a>
            <a name="@id"></a>
            <td><div style="font-family: monospace; font-size: 0.75em; color:lightgray; overflow-wrap: break-word">@prettyPrint(json)</div></td>
        } else {
            <td><div style="font-family: monospace; font-size: 0.75em; color:lightgray; overflow-wrap: break-word">@prettyPrint(excerpt(json))</div></td>
        }
        <td style="font-size:0.8em;vertical-align: top;">
            @if(id.isDefined) {
                @if(excerpt!=(identity _)){
                    @if(showId.isDefined && id.contains(showId.get)) {
                        <div><a role="button" href="/agents-external-stubs/records">Fold ...</a></div>
                    } else {
                        <div><a role="button" href="/agents-external-stubs/records?showId=@{id.get}#e">Expand ...</a></div>
                    }
                }
                <div><a role="button" href="/agents-external-stubs/records/edit?id=@{id.get}">Edit</a></div>
                <div style="margin-top:0.3em;"><a role="button" href="/agents-external-stubs/records/delete?id=@{id.get}">Remove</a></div>
            }
        </td>
    </tr>
}

@prettyPrint(json:JsValue) = {@if(json.isInstanceOf[JsObject]){
<span style="color:blue; font-weight: bold;">{</span>@ViewHelper.intersperse(json.as[JsObject].fields.map(f => prettyPrintField(f)),{<span style="color:blue;">, </span>})<span style="color:blue; font-weight: bold">}</span>} else {@if(json.isInstanceOf[JsArray]){
<span style="color:green; font-weight: bold;">[</span>@ViewHelper.intersperse(json.as[JsArray].value.map(f => prettyPrint(f)),{<span style="color:green;">, </span>})<span style="color:green; font-weight: bold">]</span>} else {@if(json.isInstanceOf[JsString]){<span>"</span><span style="color:black">@json.as[JsString].value</span>"</span>} else {<span style="color:orange">@json</span>}}}}

@prettyPrintField(field:(String,JsValue)) = {"<span style="color:gray">@field._1</span>": @prettyPrint(field._2)}